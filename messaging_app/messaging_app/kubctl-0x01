#!/usr/bin/env bash
set -euo pipefail

DEPLOYMENT="messaging-app"

echo "ðŸš€ Enabling metrics-server..."
minikube addons enable metrics-server

echo "ðŸ“ˆ Scaling deployment to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT" --replicas=3

echo "ðŸŸ¢ Verifying pods..."
kubectl get pods -l app=$DEPLOYMENT

echo "ðŸ“Š Checking resource usage..."
kubectl top pods

# Load test
MINIKUBE_IP=$(minikube ip)
NODEPORT=$(kubectl get svc messaging-app-service -o jsonpath='{.spec.ports[0].nodePort}')
echo "âš¡ Running load test with wrk..."
wrk -t2 -c50 -d30s http://$MINIKUBE_IP:$NODEPORT/
